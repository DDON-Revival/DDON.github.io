<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="translations.js"></script>
<title>DDON Account Panel</title>

<meta http-equiv="Content-Security-Policy"
content="
default-src 'self';
script-src 'self' 'unsafe-inline';
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
font-src https://fonts.gstatic.com;
connect-src https://api.ddon.org;
">

<style>
body{
    margin:0;
    background:radial-gradient(circle at top,#121425 0%,#0a0b14 60%);
    color:#e6e6e6;
    font-family:'Cinzel', serif;
}

/* HEADER */

.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:25px 80px;
    background:linear-gradient(to right,#0f111f,#14162a);
    border-bottom:1px solid #2a2d48;
}

.header h1{
    margin:0;
    font-size:30px;
    color:#c8a75d;
    letter-spacing:3px;
}

/* LANGUAGE */

#languageSelector{
    display:flex;
    gap:8px;
}

.langBtn{
    background:transparent;
    border:1px solid #c8a75d;
    color:#c8a75d;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    transition:0.25s;
}

.langBtn:hover{
    background:#c8a75d;
    color:black;
}

/* LAYOUT */

.container{
    display:flex;
    padding:60px 100px;
    gap:60px;
}

/* SIDEBAR */

.sidebar{
    width:240px;
    background:#111320;
    padding:25px;
    border:1px solid #252845;
}

.sidebar button{
    width:100%;
    margin-bottom:20px;
}

/* MAIN */

.main{
    flex:1;
}

/* CARDS */

.card{
    background:linear-gradient(145deg,#181a30,#101222);
    padding:35px;
    border:1px solid #2a2e50;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
    margin-bottom:40px;
}

.card h2{
    margin-top:0;
    color:#c8a75d;
    border-bottom:1px solid #2a2e50;
    padding-bottom:10px;
}

/* CHARACTER GRID */

.charactersGrid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:30px;
}

/* CHARACTER CARD */

.characterCard{
    background:#131528;
    border:1px solid #2a2d48;
    padding:25px;
    transition:0.3s;
}

.characterCard:hover{
    transform:translateY(-6px);
    box-shadow:0 0 20px rgba(200,167,93,0.35);
    border-color:#c8a75d;
}

.characterCard h3{
    margin:0;
    margin-bottom:10px;
    color:#ffffff;
}

.badge{
    display:inline-block;
    padding:6px 12px;
    margin-top:12px;
    border:1px solid #c8a75d;
    color:#c8a75d;
    font-size:12px;
}

/* BUTTON */

button{
    background:#c8a75d;
    border:none;
    padding:10px 14px;
    cursor:pointer;
    font-weight:bold;
    transition:0.25s;
}

button:hover{
    box-shadow:0 0 10px rgba(200,167,93,0.6);
}

/* MODAL */

#passwordModal{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:400px;
    background:#181a30;
    border:1px solid #c8a75d;
    padding:30px;
    z-index:1000;
}

#passwordModal input{
    width:100%;
    padding:8px;
    margin-bottom:15px;
    background:#0f1020;
    border:1px solid #2a2e50;
    color:white;
}

#modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    backdrop-filter:blur(4px);
    z-index:999;
}

</style>
</head>

<body>

<div id="modalOverlay" style="display:none;"></div>

<div class="header">
    <h1 data-key="accountPanelTitle"></h1>
    <div id="languageSelector"></div>
</div>

<!-- LOGIN SECTION -->
<div id="loginSection" style="display:none; padding:120px 0; text-align:center;">
    <form onsubmit="login(event)">
        <div class="card" style="max-width:400px; margin:auto;">

            <h2 data-key="login"></h2>

            <input id="username" type="text" data-placeholder="username">
            <input id="password" type="password" data-placeholder="password">

            <p id="loginMsg" style="color:#ff6b6b;"></p>

            <button type="submit" data-key="login"></button>

        </div>
    </form>
</div>

<div class="container" id="dashboardContainer" style="display:none;">

    <div class="sidebar">
        <button data-key="changePassword" onclick="openChangePassword()"></button>
        <button data-key="logout" onclick="logout()"></button>
    </div>

    <div class="main">

        <div class="card">
            <h2 data-key="dashboardTitle"></h2>
        </div>

        <h2 data-key="charactersTitle"></h2>
        <div id="characters" class="charactersGrid"></div>

    </div>

</div>

<!-- Change Password Modal -->
<div id="passwordModal" style="display:none;" class="card">

    <h3 data-key="changePassword"></h3>

    <input id="currentPass" type="password" data-placeholder="currentPassword">
    <input id="newPass" type="password" data-placeholder="newPassword">
    <input id="confirmPass" type="password" data-placeholder="confirmPassword">

    <p id="pwMsg"></p>

    <button data-key="save" onclick="changePassword()"></button>
    <button data-key="cancel" onclick="closeChangePassword()"></button>

</div>

<script>

const jobMap = {
    1: "Fighter",
    2: "Seeker",
    3: "Hunter",
    4: "Priest",
    5: "Shield Sage",
    6: "Sorcerer",
    7: "Warrior",
    8: "Element Archer",
    9: "Alchemist",
    10: "Spirit Lancer",
    11: "High Scepter"
};

async function login(event){

    if(event) event.preventDefault();

    try{
const res = await fetch("https://api.ddon.org/api/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials: "include", // ðŸ”¥ WICHTIG
    body:JSON.stringify({
        username:document.getElementById("username").value,
        password:document.getElementById("password").value
    })
});

        const data = await res.json();
		console.log("LOGIN RESPONSE:", data);

        if(res.status !== 200){
            loginMsg.textContent = data.error || "Login failed.";
            return;
        }


        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboardContainer").style.display = "flex";

        loadCharacters();

    }catch(e){
        loginMsg.textContent = "Connection error.";
    }
}

async function loadCharacters(){

    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];
    const container = document.getElementById("characters");

    try{
        const res = await fetch("https://api.ddon.org/api/characters",{
    credentials: "include" // ðŸ”¥
});

        if(!res.ok){
            container.innerHTML = "";
            const p = document.createElement("p");
            p.textContent = t.charactersLoadError;
            container.appendChild(p);
            return;
        }

        const chars = await res.json();
        container.innerHTML = "";

        if(!chars.length){
            const p = document.createElement("p");
            p.textContent = t.noCharacters;
            container.appendChild(p);
            return;
        }

        chars.forEach(c => {

            const card = document.createElement("div");
            card.className = "characterCard";

            const name = document.createElement("h3");
            name.textContent = c.name; // SAFE
            card.appendChild(name);

            const jobContainer = document.createElement("div");

            c.jobs.forEach(j => {

                const badge = document.createElement("span");
                badge.className = "badge";

                const jobName = jobMap[j.job] || j.job;
                const translatedJob =
                    translations[lang]?.jobs?.[jobName] || jobName;

                badge.textContent = translatedJob + " Lv." + j.level; // SAFE
                jobContainer.appendChild(badge);
            });

            card.appendChild(jobContainer);
            container.appendChild(card);
        });

    }catch(e){
        container.innerHTML = "";
        const p = document.createElement("p");
        p.textContent = t.characterApiError;
        container.appendChild(p);
    }
}

async function logout(){

    await fetch("https://api.ddon.org/api/logout",{
        method: "POST",
        credentials: "include"
    });

    location.reload();
}

function applyTranslations(){
    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];

    document.querySelectorAll("[data-key]").forEach(el=>{
        const key = el.getAttribute("data-key");
        if(t[key]) el.textContent = t[key];
    });

    document.querySelectorAll("[data-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-placeholder");
        if(t[key]) el.placeholder = t[key];
    });
}

/* PASSWORD */

function openChangePassword(){
    modalOverlay.style.display="block";
    passwordModal.style.display="block";
}

function closeChangePassword(){
    modalOverlay.style.display="none";
    passwordModal.style.display="none";
}

async function changePassword(){

	    console.log("TOKEN SENT:", );

    if(newPass.value !== confirmPass.value){
        const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

pwMsg.textContent = t.passwordsDontMatch || "Passwords do not match.";
        return;
    }

const res = await fetch("https://api.ddon.org/api/change-password",{
    method:"POST",
    headers:{
        "Content-Type":"application/json"
    },
    credentials: "include", // ðŸ”¥
    body:JSON.stringify({
        current:currentPass.value,
        new:newPass.value
    })
});

    const data = await res.json();
    const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

pwMsg.textContent =
    data.message ||
    data.error ||
    t.unknownError ||
    "Unknown error.";
}

function initLanguageSelector(){

    const container = document.getElementById("languageSelector");
    container.innerHTML = "";

    const currentLang = localStorage.getItem("lang") || "en";

    window.languages.forEach(lang=>{
        const btn = document.createElement("button");
        btn.className = "langBtn";
        btn.innerText = lang.flag + " " + lang.code.toUpperCase();

        if(lang.code === currentLang){
            btn.style.background = "#c8a75d";
            btn.style.color = "black";
        }

        btn.onclick = ()=>{
            localStorage.setItem("lang", lang.code);
            location.reload();
        };

        container.appendChild(btn);
    });
}

window.onload = function(){

    initLanguageSelector();
    applyTranslations();

    fetch("https://api.ddon.org/api/characters",{
        credentials: "include"
    }).then(res => {
        if(res.ok){
            document.getElementById("dashboardContainer").style.display = "flex";
            loadCharacters();
        } else {
            document.getElementById("loginSection").style.display = "block";
        }
    });
};

</script>

</body>
</html>