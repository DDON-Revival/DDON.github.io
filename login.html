<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="translations.js"></script>
<title>DDON Account Panel</title>

<style>
body{
    background:#0f0f14;
    color:#e6e6e6;
    font-family:'Cinzel', serif;
    text-align:center;
}

.card{
    background:#1b1b25;
    padding:30px;
    margin:20px auto;
    width:350px;
    border:1px solid #2a2a35;
    box-shadow:0 0 15px rgba(200,167,93,0.2);
    transition:0.3s;
}

.card:hover{
    box-shadow:0 0 25px rgba(200,167,93,0.4);
}

input{
    width:90%;
    padding:8px;
    margin:8px;
    background:#111;
    border:1px solid #333;
    color:white;
}

button{
    padding:8px 15px;
    background:#c8a75d;
    border:none;
    cursor:pointer;
}

.badge{
    display:inline-block;
    padding:4px 8px;
    margin:4px;
    border:1px solid #c8a75d;
    font-size:12px;
    background:#111;
}
.online{color:#4caf50;}
.offline{color:#f44336;}

#languageSelector{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    padding:20px 40px;
}

.langBtn{
    background:#1b1b25;
    border:1px solid #c8a75d;
    color:white;
    padding:6px 10px;
    margin:2px;
    cursor:pointer;
    font-size:14px;
    transition:0.2s;
}

.langBtn:hover{
    background:#c8a75d;
    color:black;
}

</style>
</head>

<body>

<h1 data-key="accountPanelTitle"></h1>

<div id="languageSelector"></div>

<div class="card" id="loginBox">
<input id="username" data-placeholder="username">
<input id="password" type="password" data-placeholder="password">
    <button data-key="login" onclick="login()"></button>
    <p id="loginMsg"></p>
</div>

<div id="dashboard" style="display:none;">
    <div class="card">
        <h2 data-key="dashboardTitle"></h2>
		<button data-key="changePassword" onclick="openChangePassword()"></button>
		<button data-key="logout" onclick="logout()"></button>
    </div>

    <h2 data-key="charactersTitle"></h2>
    <div id="characters"></div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" style="display:none;" class="card">

    <h3 data-key="changePassword"></h3>

    <input id="currentPass" type="password" data-placeholder="currentPassword">
    <input id="newPass" type="password" data-placeholder="newPassword">
    <input id="confirmPass" type="password" data-placeholder="confirmPassword">

    <p id="pwMsg"></p>

    <button data-key="save" onclick="changePassword()"></button>
    <button data-key="cancel" onclick="closeChangePassword()"></button>

</div>

<script>

const jobMap = {
    1: "Fighter",
    2: "Seeker",
    3: "Hunter",
    4: "Priest",
    5: "Shield Sage",
    6: "Sorcerer",
    7: "Warrior",
    8: "Element Archer",
    9: "Alchemist",
    10: "Spirit Lancer",
    11: "High Scepter"
};

async function login(){
    try{
        const res = await fetch("https://api.ddon.org/api/login",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                username:username.value,
                password:password.value
            })
        });

        if(!res.ok){
            const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

loginMsg.textContent = t.connectionError || "Connection error.";
            return;
        }

        const data = await res.json();

        if(data.token){
            localStorage.setItem("token",data.token);
            loginBox.style.display="none";
            dashboard.style.display="block";
            loadCharacters();
        } else {
            const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

loginMsg.textContent = t.loginFailed || "Login failed.";
        }

    }catch(e){
        const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

loginMsg.textContent = t.loginServerUnavailable || "Login server unavailable.";
    }
}

async function loadCharacters(){

    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];

    try{
        const res = await fetch("https://api.ddon.org/api/characters",{
            headers:{
                "Authorization":"Bearer "+localStorage.getItem("token")
            }
        });

        if(!res.ok){
            characters.innerHTML = `<p>${t.charactersLoadError || "Could not load characters."}</p>`;
            return;
        }

        const chars = await res.json();
        characters.innerHTML="";

        if(!chars.length){
            characters.innerHTML = `<p>${t.noCharacters || "No characters found."}</p>`;
            return;
        }

        chars.forEach(c => {

            const jobName = jobMap[c.job] || c.job;
            const translatedJob =
                translations[lang]?.jobs?.[jobName] || jobName;

            characters.innerHTML += `
                <div class="card">
                    <h3>${c.first_name} ${c.last_name}</h3>
                    <p>${t.level}: ${c.lv}</p>
                    <div>
                        <span class="badge">${translatedJob}</span>
                    </div>
                </div>
            `;
        });

    }catch(e){
        characters.innerHTML = `<p>${t.characterApiError || "Character API error."}</p>`;
    }
}

async function loadStatus(){
    try{
        const res = await fetch("https://api.ddon.org/api/account-status",{
            headers:{
                "Authorization":"Bearer "+localStorage.getItem("token")
            }
        });

        if(!res.ok){
            onlineStatus.innerHTML = `<span class="offline">ðŸ”´ Status unavailable</span>`;
            return;
        }

        const data = await res.json();

        if(data.online){
            onlineStatus.innerHTML = `<span class="online">ðŸŸ¢ Online</span>`;
        }else{
            onlineStatus.innerHTML = `<span class="offline">ðŸ”´ Offline</span>`;
        }

    }catch(e){
        onlineStatus.innerHTML = `<span class="offline">ðŸ”´ API Error</span>`;
    }
}

function logout(){
    localStorage.removeItem("token");
    location.reload();
}

function applyTranslations(){
    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];

    document.querySelectorAll("[data-key]").forEach(el=>{
        const key = el.getAttribute("data-key");
        if(t[key]) el.textContent = t[key];
    });

    document.querySelectorAll("[data-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-placeholder");
        if(t[key]) el.placeholder = t[key];
    });
}

/* PASSWORD */

function openChangePassword(){
    passwordModal.style.display="block";
}

function closeChangePassword(){
    passwordModal.style.display="none";
}

async function changePassword(){

    if(newPass.value !== confirmPass.value){
        const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

pwMsg.textContent = t.passwordsDontMatch || "Passwords do not match.";
        return;
    }

    const res = await fetch("https://api.ddon.org/api/change-password",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+localStorage.getItem("token")
        },
        body:JSON.stringify({
            current:currentPass.value,
            new:newPass.value
        })
    });

    const data = await res.json();
    const lang = localStorage.getItem("lang") || "en";
const t = translations[lang];

pwMsg.textContent =
    data.message ||
    data.error ||
    t.unknownError ||
    "Unknown error.";
}

function initLanguageSelector(){

    const container = document.getElementById("languageSelector");
    container.innerHTML = "";

    const currentLang = localStorage.getItem("lang") || "en";

    window.languages.forEach(lang=>{
        const btn = document.createElement("button");
        btn.className = "langBtn";
        btn.innerText = lang.flag + " " + lang.code.toUpperCase();

        if(lang.code === currentLang){
            btn.style.background = "#c8a75d";
            btn.style.color = "black";
        }

        btn.onclick = ()=>{
            localStorage.setItem("lang", lang.code);
            location.reload();
        };

        container.appendChild(btn);
    });
}

window.onload = function(){

    initLanguageSelector();
    applyTranslations();

    const token = localStorage.getItem("token");

    if(token){
        loginBox.style.display="none";
        dashboard.style.display="block";
        loadCharacters();
    }
};

</script>

</body>
</html>