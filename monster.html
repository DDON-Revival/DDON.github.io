<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DDON – Monster</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>DDON Wiki</h2>
    <a href="index.html">Home</a>
    <a href="monster.html">Monsters</a>
    <a href="drops.html">Drop Search</a>
    <a href="stage.html?id=1">Stages</a>
    <a href="item.html?id=1">Item Search</a>	
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div id="content">Loading…</div>
  </main>

</div>

<script type="module">
import { parseDDON } from "./js/ddon-parser.js";
import { loadEnemyNames } from "./js/enemy-names.js";
import { loadEnemySpecies } from "./js/enemy-species.js";
import { loadItemNames } from "./js/item-names.js";

const enemyId = new URLSearchParams(location.search).get("id");

Promise.all([
  fetch("data/EnemySpawn.json").then(r => r.json()),
  fetch("data/stage-names.json").then(r => r.json()),
  loadEnemyNames(),
  loadEnemySpecies(),
  loadItemNames()
]).then(([enemyData, stageNames, enemyNames, enemySpecies, itemNames]) => {

  const { enemies } = parseDDON(enemyData);
  const spawns = enemies.filter(e => String(e.EnemyId) === enemyId);

  if (!spawns.length) {
    document.getElementById("content").innerHTML = "<h1>Monster not found</h1>";
    return;
  }

  const name = enemyNames[enemyId] || `Enemy ${enemyId}`;
  const species = enemySpecies[enemyId] || "Unknown";

  const levels = spawns.map(s => s.Lv);
  const minLv = Math.min(...levels);
  const maxLv = Math.max(...levels);

  const dropTable = spawns.find(s => s.drops)?.drops;

  const dropsHtml = dropTable?.items
    ? `<ul>${dropTable.items.map(d => {
        const n = itemNames[d.ItemId]?.en || `Item ${d.ItemId}`;
        return `<li><a href="item.html?id=${d.ItemId}">${n}</a> (${Math.round(d.DropChance*100)}%)</li>`;
      }).join("")}</ul>`
    : "<p>No drops</p>";

  const stages = [...new Set(spawns.map(s => s.StageId))];

  document.getElementById("content").innerHTML = `
    <h1>${name}</h1>
    <p><b>EnemyId:</b> ${enemyId}</p>
    <p><b>Species:</b> ${species}</p>
    <p><b>Level Range:</b> ${minLv} – ${maxLv}</p>

    <h2>Drops</h2>
    ${dropsHtml}

    <h2>Spawn Stages</h2>
    <ul>
      ${stages.map(id => `<li><a href="stage.html?id=${id}">Stage ${id}</a></li>`).join("")}
    </ul>
  `;
});
</script>

</body>
</html>
