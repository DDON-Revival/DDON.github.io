<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DDON – Monster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div id="content">Loading…</div>

<script type="module">
import { parseDDON } from "./js/ddon-parser.js";
import { loadEnemyNames } from "./js/enemy-names.js";
import { loadEnemySpecies } from "./js/enemy-species.js";

/* ---------- ITEM NAMES (INLINE PARSER) ---------- */
async function loadItemNames() {
  const res = await fetch(
    "https://raw.githubusercontent.com/riftcrystal/DDON-Translation/master/ui/00_message/common/item_name.toml",
    { cache: "no-store" }
  );

  const text = await res.text();
  const map = {};
  let current = null;

  const commit = () => {
    if (current && current.id && current.new) {
      map[String(current.id)] = current.new;
    }
  };

  text.split("\n").forEach(line => {
    line = line.trim();

    if (line === "[[item]]") {
      commit();
      current = {};
      return;
    }

    if (!current) return;

    if (line.startsWith("id")) {
      current.id = line.split("=")[1].trim();
      return;
    }

    if (line.startsWith("new")) {
      current.new = line.split("=").slice(1).join("=").trim()
        .replace(/^['"]|['"]$/g, "");
    }
  });

  commit();
  return map;
}

/* ---------- MAIN ---------- */
const enemyId = new URLSearchParams(location.search).get("id");

Promise.all([
  fetch("data/EnemySpawn.json", { cache: "no-store" }).then(r => r.json()),
  loadItemNames(),
  loadEnemyNames(),
  loadEnemySpecies()
]).then(([enemyData, itemNames, enemyNames, enemySpecies]) => {

  const { enemies } = parseDDON(enemyData);

  const spawns = enemies.filter(e =>
    String(e.EnemyId).toLowerCase() === String(enemyId).toLowerCase()
  );

  if (!spawns.length) {
    document.getElementById("content").innerHTML =
      `<h1>Monster not found</h1><p>${enemyId}</p>`;
    return;
  }

  const name = enemyNames[enemyId] || `Enemy ${enemyId}`;
  const species =
    enemySpecies[enemyId] ||
    enemySpecies[name] ||
    "Unknown";

  const levels = spawns.map(s => s.Lv);
  const minLv = Math.min(...levels);
  const maxLv = Math.max(...levels);

  const dropTable = spawns.find(s => s.drops)?.drops;

  let dropsHtml = "<p>No drops</p>";
  if (dropTable?.items) {
    dropsHtml = `
      <ul>
        ${dropTable.items.map(d => {
          const itemName = itemNames[String(d.ItemId)] || `Item ${d.ItemId}`;
          const chance = Math.round(d.DropChance * 100);
          return `
            <li>
              <a href="item.html?id=${d.ItemId}">
                ${itemName}
              </a>
              (${chance}%)
            </li>
          `;
        }).join("")}
      </ul>
    `;
  }

  const stages = [...new Set(spawns.map(s => s.StageId))];

  document.getElementById("content").innerHTML = `
    <h1>${name}</h1>

    <p><b>EnemyId:</b> ${enemyId}</p>
    <p><b>Species:</b> ${species}</p>
    <p><b>Level Range:</b> ${minLv} – ${maxLv}</p>
    <p><b>Spawn Count:</b> ${spawns.length}</p>

    <h2>Drops</h2>
    ${dropsHtml}

    <h2>Spawn Stages</h2>
    <ul>
      ${stages.map(s => `<li>Stage ${s}</li>`).join("")}
    </ul>
  `;
});
</script>

</body>
</html>
