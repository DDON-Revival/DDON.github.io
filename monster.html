<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DDON – Monster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div id="content">Loading…</div>

<script type="module">
import { parseDDON } from "./js/ddon-parser.js";
import { groupByEnemy } from "./js/monster-utils.js";
import { loadItemNames } from "./js/item-names.js";
import { loadEnemyNames } from "./js/enemy-names.js";
import { loadEnemySpecies } from "./js/enemy-species.js";

const enemyId = new URLSearchParams(location.search).get("id");

Promise.all([
  fetch("data/EnemySpawn.json").then(r => r.json()),
  loadItemNames(),
  loadEnemyNames(),
  loadEnemySpecies()
]).then(([enemyData, itemNames, enemyNames, enemySpecies]) => {

  const { enemies } = parseDDON(enemyData);
  const monsters = groupByEnemy(enemies);

  const monster = monsters.find(m => String(m.id) === String(enemyId));

  if (!monster) {
    document.getElementById("content").innerHTML =
      "<h1>Monster not found</h1>";
    return;
  }

  const name = enemyNames[enemyId] || `Enemy ${enemyId}`;
  const species = enemySpecies[enemyId] || "Unknown";
  const level = `${monster.minLv} – ${monster.maxLv}`;
  const spawnCount = monster.spawns.length;

  let dropsHtml = "<p>No drops</p>";
  if (monster.drops && monster.drops.items) {
    dropsHtml = `
      <ul>
        ${monster.drops.items.map(d => {
          const itemName =
            itemNames[d.ItemId]?.en || `Item ${d.ItemId}`;
          const chance = Math.round(d.DropChance * 100);
          return `<li>${itemName} (${chance}%)</li>`;
        }).join("")}
      </ul>
    `;
  }

  document.getElementById("content").innerHTML = `
    <h1>${name}</h1>

    <p><b>EnemyId:</b> ${enemyId}</p>
    <p><b>Species:</b> ${species}</p>
    <p><b>Level Range:</b> ${level}</p>
    <p><b>Spawn Count:</b> ${spawnCount}</p>

    <h2>Drops</h2>
    ${dropsHtml}

    <h2>Spawns</h2>
    <ul>
      ${monster.spawns.map(s =>
        `<li>Stage ${s.stage}</li>`
      ).join("")}
    </ul>
  `;
});
</script>

</body>
</html>
