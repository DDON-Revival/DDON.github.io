<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DDON Ultra Wiki</title>

<style>
body{
    background:#0e0e0e;
    color:white;
    font-family:Arial;
    margin:0;
    padding:20px;
}

h1{
    text-align:center;
}

.search{
    text-align:center;
    margin-bottom:20px;
}

input{
    padding:8px;
    width:300px;
}

button{
    padding:8px 15px;
    cursor:pointer;
}

.card{
    background:#1b1b1b;
    padding:15px;
    margin-bottom:15px;
    border-radius:6px;
}

.drop{
    margin-left:15px;
    color:#bbb;
}
</style>
</head>

<body>

<h1>ULTRA WIKI GOD MODE</h1>

<div class="search">
<input id="search" placeholder="Search enemy name...">
<button onclick="runSearch()">Search</button>
</div>

<div id="results"></div>

<script>

const BASE = "https://raw.githubusercontent.com/DDON-Revival/DDON.github.io/main/datas/";

let enemySpawn;
let enemyNames;
let stageNames;
let itemNames = {};

async function loadData(){

    const [
        spawnRes,
        enemyRes,
        stageRes,
        itemRes
    ] = await Promise.all([
        fetch(BASE+"EnemySpawn.json"),
        fetch(BASE+"enemy-names.json"),
        fetch(BASE+"stage-names.json"),
        fetch(BASE+"item_name.toml")
    ]);

    enemySpawn = await spawnRes.json();
    enemyNames = await enemyRes.json();
    stageNames = await stageRes.json();

    const tomlText = await itemRes.text();
    parseItemToml(tomlText);

    console.log("All data loaded");
}

function parseItemToml(text){

    const lines = text.split("\n");

    lines.forEach(line=>{
        const match = line.match(/^(\d+)\s*=\s*"(.*)"/);
        if(match){
            itemNames[match[1]] = match[2];
        }
    });
}

function getEnemyName(id){
    return enemyNames[id] || id;
}

function getStageName(id){
    if(stageNames[id])
        return stageNames[id].en;
    return "Unknown";
}

function getItemName(id){
    return itemNames[id] || id;
}

function runSearch(){

    const query = document.getElementById("search").value.toLowerCase();
    const container = document.getElementById("results");
    container.innerHTML = "";

    enemySpawn.enemies.forEach(e=>{

        const enemyId = e[5];
        const name = getEnemyName(enemyId);

        if(name.toLowerCase().includes(query)){

            const stage = getStageName(e[0]);
            const level = e[9];
            const exp = e[26];
            const dropId = e[27];

            const dropTable = enemySpawn.dropsTables.find(d=>d.id == dropId);

            let dropHTML = "";

            if(dropTable){
                dropTable.items.forEach(item=>{
                    const itemId = item[0];
                    const chance = item[5];
                    dropHTML += `<div class="drop">
                        ${getItemName(itemId)} 
                        (${Math.round(chance*100)}%)
                    </div>`;
                });
            }

            container.innerHTML += `
                <div class="card">
                    <b>${name}</b><br>
                    Stage: ${stage}<br>
                    Level: ${level}<br>
                    EXP: ${exp}
                    <div style="margin-top:10px;">
                        <b>Drops:</b>
                        ${dropHTML || "None"}
                    </div>
                </div>
            `;
        }
    });
}

loadData();

</script>

</body>
</html>
