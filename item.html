<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DDON – Item</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div id="content">Loading…</div>

<script type="module">
import { parseDDON } from "./js/ddon-parser.js";
import { loadEnemyNames } from "./js/enemy-names.js";

/* ---------- ITEM NAME LOADER (INLINE, WIE BEI MONSTER) ---------- */
async function loadItemNames() {
  const res = await fetch(
    "https://raw.githubusercontent.com/riftcrystal/DDON-Translation/master/ui/00_message/common/item_name.toml",
    { cache: "no-store" }
  );

  const text = await res.text();
  const map = {};
  let current = null;

  const commit = () => {
    if (current && current.id && current.new) {
      map[String(current.id)] = current.new;
    }
  };

  text.split("\n").forEach(line => {
    line = line.trim();

    if (line === "[[item]]") {
      commit();
      current = {};
      return;
    }

    if (!current) return;

    if (line.startsWith("id")) {
      current.id = line.split("=")[1].trim();
      return;
    }

    if (line.startsWith("new")) {
      current.new = line
        .split("=")
        .slice(1)
        .join("=")
        .trim()
        .replace(/^['"]|['"]$/g, "");
    }
  });

  commit();
  return map;
}

/* ---------- MAIN ---------- */
const itemId = new URLSearchParams(location.search).get("id");

Promise.all([
  fetch("data/EnemySpawn.json", { cache: "no-store" }).then(r => r.json()),
  loadItemNames(),
  loadEnemyNames()
]).then(([enemyData, itemNames, enemyNames]) => {

  const { enemies, dropsTables } = parseDDON(enemyData);

  const itemName = itemNames[itemId] || `Item ${itemId}`;

  /* Alle DropTables finden, die dieses Item enthalten */
  const tablesWithItem = dropsTables.filter(t =>
    t.items.some(i => String(i.ItemId) === String(itemId))
  );

  /* EnemyId + DropChance sammeln */
  const drops = [];

  enemies.forEach(e => {
    const table = tablesWithItem.find(t => t.id === e.DropsTableId);
    if (!table) return;

    const item = table.items.find(i =>
      String(i.ItemId) === String(itemId)
    );

    if (!item) return;

    drops.push({
      enemyId: e.EnemyId,
      chance: Math.round(item.DropChance * 100)
    });
  });

  /* Deduplizieren nach EnemyId + Chance */
  const unique = {};
  drops.forEach(d => {
    const key = `${d.enemyId}-${d.chance}`;
    if (!unique[key]) unique[key] = d;
  });

  const list = Object.values(unique);

  let listHtml = "<p>No monsters drop this item.</p>";

  if (list.length) {
    listHtml = `
      <ul>
        ${list.map(d => {
          const enemyName =
            enemyNames[d.enemyId] || `Enemy ${d.enemyId}`;
          return `
            <li>
              <a href="monster.html?id=${d.enemyId}">
                ${enemyName}
              </a>
              (${d.chance}%)
            </li>
          `;
        }).join("")}
      </ul>
    `;
  }

  document.getElementById("content").innerHTML = `
    <h1>${itemName}</h1>
    <p><b>Item ID:</b> ${itemId}</p>

    <h2>Dropped by</h2>
    ${listHtml}
  `;
});
</script>

</body>
</html>
