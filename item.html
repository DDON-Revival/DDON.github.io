<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DDON – Monster</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>DDON Wiki</h2>
    <a href="index.html">Home</a>
    <a href="monster-search.html">Monsters</a>
    <a href="item-search.html">Item Search</a>
    <a href="stage-search.html?id=1">Stages</a>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div id="content">Loading…</div>
  </main>

</div>

<script type="module">
import { parseDDON } from "./js/ddon-parser.js";
import { loadEnemyNames } from "./js/enemy-names.js";

/* ---------- inline item-name loader (funktioniert sicher) ---------- */
async function loadItemNames() {
  const res = await fetch(
    "https://raw.githubusercontent.com/riftcrystal/DDON-Translation/master/ui/00_message/common/item_name.toml",
    { cache: "no-store" }
  );

  const text = await res.text();
  const map = {};
  let current = null;

  const commit = () => {
    if (current && current.id && current.new) {
      map[String(current.id)] = current.new;
    }
  };

  text.split("\n").forEach(line => {
    line = line.trim();

    if (line === "[[item]]") {
      commit();
      current = {};
      return;
    }

    if (!current) return;

    if (line.startsWith("id")) {
      current.id = line.split("=")[1].trim();
      return;
    }

    if (line.startsWith("new")) {
      current.new = line
        .split("=")
        .slice(1)
        .join("=")
        .trim()
        .replace(/^['"]|['"]$/g, "");
    }
  });

  commit();
  return map;
}

/* ---------- main ---------- */
const itemId = new URLSearchParams(location.search).get("id");

Promise.all([
  fetch("data/EnemySpawn.json", { cache: "no-store" }).then(r => r.json()),
  loadEnemyNames(),
  loadItemNames()
]).then(([enemyData, enemyNames, itemNames]) => {

  if (!itemId) {
    document.getElementById("content").innerHTML =
      "<h1>No Item ID provided</h1>";
    return;
  }

  const itemName = itemNames[itemId] || `Item ${itemId}`;
  const { enemies } = parseDDON(enemyData);

  /* build drop list */
  const drops = [];

  enemies.forEach(e => {
    if (!e.drops || !e.drops.items) return;

    e.drops.items.forEach(d => {
      if (String(d.ItemId) !== String(itemId)) return;

      drops.push({
        enemyId: e.EnemyId,
        chance: Math.round(d.DropChance * 100)
      });
    });
  });

  /* deduplicate enemies (wichtig!) */
  const unique = {};
  drops.forEach(d => {
    const key = d.enemyId;
    if (!unique[key]) unique[key] = d;
  });

  const list = Object.values(unique);

  document.getElementById("content").innerHTML = `
    <h1>${itemName}</h1>
    <p><b>Item ID:</b> ${itemId}</p>

    <h2>Dropped by</h2>
    ${
      list.length
        ? `<ul>
            ${list.map(d => {
              const name =
                enemyNames[d.enemyId] || `Enemy ${d.enemyId}`;
              return `
                <li>
                  <a href="monster.html?id=${d.enemyId}">
                    ${name}
                  </a> (${d.chance}%)
                </li>`;
            }).join("")}
          </ul>`
        : "<p>No enemies drop this item.</p>"
    }
  `;
}).catch(err => {
  console.error(err);
  document.getElementById("content").innerHTML =
    "<h1>Error loading item</h1>";
});
</script>

</body>
</html>
